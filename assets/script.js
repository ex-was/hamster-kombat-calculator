const config = {
	pr: {
		name: 'PR&Team',
		items: {
			ceo: { name: 'CEO' },
			marketing: { name: 'Marketing' },
			it: { name: 'IT team' },
			support: { name: 'Support team' },
			hb: { name: 'HamsterBook' },
			ht: { name: 'HamsterTube' },
			x: { name: 'X' },
			cointelegraph: { name: 'Cointelegraph' },
			hg: { name: 'HamsterGram' },
			tiktok: { name: 'TikTok' },
			coindesk: { name: 'Coindesk' },
			influencers: { name: 'Influencers' },
			partnership: { name: 'Partnership program' },
			pt: { name: 'Product team' },
			bigdev: { name: 'BisDev team' },
			f2a: { name: 'Two factor authentication' },
			uxui: { name: 'UX and UI team' },
			security: { name: 'Security team' },
			qa: { name: 'QA team' },
			shield: { name: 'Antihacking shield' },
			risk: { name: 'Risk management team' },
			audit: { name: 'Security Audition' },
			txban: { name: 'Anonymous transactions ban' },
			block: { name: 'Blocking suspicious accounts' },
			tokenomics: { name: 'Tokenomics expert' },
			exppass: { name: 'Consensus Explorer pass' },
			vc: { name: 'VS labs' },
			officer: { name: 'Compliance officer' },
			wmas: { name: 'Welcome to Amsterdam' },
			devmumbai: { name: 'Development Hub Mumbai' },
			dct: { name: 'Data Center Tokyo' },
			lb: { name: 'Leaderboards' },
			minigame: { name: 'Minigame' }
		}
	},
	markets: {
		name: 'Markets',
		items: {
			fan: { name: 'Fan tokens' },
			staking: { name: 'Staking' },
			btc: { name: 'BTC Pairs' },
			eth: { name: 'ETH Pairs' },
			cmc: { name: 'Top 10 cmc pairs' },
			gamefi: { name: 'GameFi tokens' },
			defi20: { name: 'Defi2.0 tokens' },
			socialfi: { name: 'SocialFi tokens' },
			meme: { name: 'Meme coins' },
			shit: { name: 'Shit coins' },
			x10: { name: 'Margin trading x10' },
			x20: { name: 'Margin trading x20' },
			x30: { name: 'Margin trading x30' },
			x50: { name: 'Margin trading x50' },
			x75: { name: 'Margin trading x75' },
			x100: { name: 'Margin trading x100' },
			derivatives: { name: 'Derivatives' },
			pmarkets: { name: 'Prediction markets' },
			web3: { name: 'Web3 integration' },
			dao: { name: 'DAO' },
			p2p: { name: 'P2P trading' },
			bots: { name: 'Trading bots' },
			lzlisting: { name: 'LayerZero Listing' }
		}
	},
	legal: {
		name: 'Legal',
		items: {
			kyc: { name: 'KYC' },
			kyb: { name: 'KYB' },
			legal: { name: 'Legal opinion' },
			sec: { name: 'SEC transparency' },
			aml: { name: 'Anti money loundering' },
			luae: { name: 'License UAE' },
			leu: { name: 'License Europe' },
			lasia: { name: 'License Asia' },
			lsa: { name: 'License South America' },
			lau: { name: 'License Australia' },
			lna: { name: 'License North America' },
			ln: { name: 'License Nigeria' },
			ljp: { name: 'License Japan' },
			leth: { name: 'License Ethiopia' },
			lindia: { name: 'License India' },
			lbangladesh: { name: 'License Bangladesh' },
			lind: { name: 'License Indonesia' },
			lvn: { name: 'License Vietnam' },
			lt: { name: 'License Turkey' },
			lph: { name: 'License Philippines' }
		}
	},
	web3: {
		name: 'Web3',
		items: {
			dex: { name: 'DEX' },
			oracle: { name: 'Oracle' },
			vesting: { name: 'Vesting Smartcontracts' },
			lp: { name: 'Launchpad' },
			nft: { name: 'NFT Marketplace' },
			grant: { name: 'Grant for Developers' },
			metaverse: { name: 'NFT Metaverse' },
			farm: { name: 'Crypto Farming' },
			sport: { name: 'Sport Collectibles Marketplace' },
			market: { name: 'Market Making' },
			adv: { name: 'Web3 Advertising Platform' }
		}
	},
	specials: {
		name: 'Specials',
		items: {
			//paris: { name: 'Games in Paris' },
			health: { name: 'Healthy nutrition hamster' },
			sleeping: { name: 'Sleeping hamster' },
			gpt: { name: 'HamsterGPT' },
			//fin: { name: 'This is fine' },
			//bdayeth: { name: 'Ethereum birthday' },
			//water: { name: 'Hamsters tested the purity of the water' },
			hot: { name: 'Carry it like it`s hot' },
			//btc: { name: 'Bitcoin Conference 2024' },
			//kamala: { name: 'Kamala is calling' },
			bank: { name: 'HamsterBank' },
			stats: { name: 'Telegram Stats integration' },
			miniapp: { name: 'Telegram Miniapp Launch' },
			//au: { name: 'Strategic session in Australia' },
			analytics: { name: 'Hamster Analytics' },
			celebrate: { name: '50m Telegram channel' },
			//fight: { name: 'Fight fight fight' },
			appstore: { name: 'HamsterStore launch' },
			rolex: { name: 'Rolex for soulmate' },
			btcr: { name: 'Call for BTC to rise' },
			jet: { name: 'Business jet' },
			//taps: { name: 'Percussion taps' },
			cxi: { name: 'CX Hub Istanbul' },
			records: { name: 'Hamster break records' },
			x10m: { name: 'X Network 10 Million' },
			green: { name: 'Hamster Green energy' },
			yt25: { name: 'YouTube 25 Million' },
			tgl: { name: 'TG Leaders' },
			premarket: { name: 'Premarket Launch' },
			merch: { name: 'Hamster Kombat Merch' },
			pizza: { name: 'Bitcoin Pizza Day' },
			ytchannel: { name: 'Hamster YouTube Channel' },
			ytbutton: { name: 'YouTube Gold Button' },
			web3a: { name: 'Web3 academy launch' },
			piranha: { name: 'Consensus Piranha Pass' },
			tonham: { name: 'TON + Hamster Kombat = Success' },
			nftl: { name: 'NFT Collection Launch' },
			top10: { name: 'Top 10 Global Ranking' },
			twochairs: { name: 'There are two chairs...' },
			conference: { name: 'Special Hamster Conference' },
			adc: { name: 'Ad contract with football club' },
			short: { name: 'Short squeeze' },
			long: { name: 'Long squeeze' },
			villa: { name: 'Villa for the DEV team' },
			appscl: { name: 'Apps Center Listing' },
			bogdanoff: { name: 'Bogdanoff is calling' },
			tonusdt: { name: 'USDT on TON' }
		}
	}
};

const formatter = Intl.NumberFormat('en', { notation: 'compact' });
const dump = document.querySelector('textarea[name="dump"]');

dump.value = localStorage.getItem('dump')?.length ? localStorage.getItem('dump') : '';

const boot = () => {
	const saved = dump.value.length ? JSON.parse(dump.value) : {};
	const daily = localStorage.getItem('daily')?.length ? JSON.parse(localStorage.getItem('daily')) : [];

	for(const key in config) {
		const $template = document.createElement('template');

		$template.innerHTML = `<div class="category" data-key><div class="name"></div><div class="items"></div></div>`;
		$template.content.querySelector('.category').dataset.key = key;
		$template.content.querySelector('.name').innerText = config[key].name;

		document.querySelector('.calculator .categories').append($template.content);

		const $items = document.querySelector(`.categories .category[data-key="${key}"] .items`);

		for(const k in config[key].items) {
			const i = config[key].items[k];
			const isDaily = daily.findIndex((item) => item[0] === key && item[1] === k) > -1;

			const cost = key in saved && k in saved[key] ? saved[key][k][0] : 0;
			const profit = key in saved && k in saved[key] ? saved[key][k][1] : 0;

			$items.insertAdjacentHTML(
				'beforeend',
				`<div class="item${isDaily ? ' daily' : ''}" data-key="${k}">
                    <div class="name">${i.name}<span></span></div>
                    <div class="opinions">
						<div>
							<label>Upgrade cost</label>
							<input type="number" name="cost" value="${cost}" onkeyup="update();calculate()" onchange="update();calculate()" pattern="[0-9]*" inputmode="numeric" />
						</div>
						<div>
							<label>Profit/hour</label>
							<input type="number" name="profit" value="${profit}" onkeyup="update();calculate()" onchange="update();calculate()" pattern="[0-9]*" inputmode="numeric" />
						</div>
					</div>
					<!--div class="daily">
						<span onclick="markAsDaily(this);">${isDaily ? 'is not' : 'is'} daily</span>
					</div-->
                </div>`
			);
		}
	}

	calculate();
};

const update = () => {
	const saved = {};

	document.querySelectorAll('.calculator .categories .category').forEach((element) => {
		saved[element.dataset.key] = {};

		element.querySelectorAll('.items .item').forEach((el) => {
			saved[element.dataset.key][el.dataset.key] = [
				Number(el.querySelector('[name="cost"]').value || 0), Number(el.querySelector('[name="profit"]').value || 0)
			];
		});
	});

	dump.value = JSON.stringify(saved);
	store();
};

const calculate = () => {
	let items = [];
	let total = 0;

	document.querySelectorAll('.calculator .categories .category').forEach((element) => {
		element.querySelectorAll('.items .item').forEach((el) => {
			const cost = Number(el.querySelector('[name="cost"]').value);
			const profit = Number(el.querySelector('[name="profit"]').value);
			const value = profit > 0 ? profit / cost : 0;

			total += value;

			items.push({
				category: element.dataset.key,
				item: el.dataset.key,
				value, cost, profit
			});
		});
	});

	items = items.sort((a, b) => a.value - b.value).reverse();

	if(items.length >= 3) {
		document.querySelectorAll('.calculator .categories .category').forEach((element) => {
			element.querySelectorAll('.items .item').forEach((el) => {
				if(el.classList.contains('best')) {
					el.classList.remove('best');
				}

				const profit = Number(el.querySelector('[name="profit"]').value);
				const value = profit > 0 ? profit / Number(el.querySelector('[name="cost"]').value) : 0;

				el.querySelector('.name > span').innerText = isNaN(value) ? '0%' : `${Math.round(value / total * 10000) / 100}%`;
			});
		});

		const text = [];

		for(let i = 0; i < 3; i++) {
			const value = items[i];
			const percent = Math.round(value.value / total * 10000) / 100;

			text.push(`<div>${config[value.category].items[value.item].name} in ${config[value.category].name} (${formatter.format(value.profit)} per hour for ${formatter.format(value.cost)}) - ${percent}%</div>`);
			document.querySelector(`.calculator .categories .category[data-key="${value.category}"] .items .item[data-key="${value.item}"]`).classList.add('best');
		}

		document.querySelector('.results').innerHTML = text.join('\n');

		return;
	}

	document.querySelector('.results').innerText = `Fill data before start`;
};

const fill = () => {
	const saved = dump.value.length ? JSON.parse(dump.value) : {};

	document.querySelectorAll('.calculator .categories .category').forEach((element) => {
		element.querySelectorAll('.items .item').forEach((el) => {
			el.querySelector('[name="cost"]').value = element.dataset.key in saved && el.dataset.key in saved[element.dataset.key] ? saved[element.dataset.key][el.dataset.key][0] : 0;
			el.querySelector('[name="profit"]').value = element.dataset.key in saved && el.dataset.key in saved[element.dataset.key] ? saved[element.dataset.key][el.dataset.key][1] : 0;
		});
	});

	store();
	calculate();
}

const store = () => {
	if(!dump.value.length) {
		localStorage.removeItem('dump');
		return;
	}

	try {
		if(Object.prototype.toString.call(JSON.parse(dump.value)) === '[object Object]') {
			localStorage.setItem('dump', dump.value);
		}
	}
	catch(e) {
		console.error(e.message);
	}
}

const markAsDaily = (element) => {
	let cached = localStorage.getItem('daily')?.length ? JSON.parse(localStorage.getItem('daily')) : [];

	const keys = [
		element.parentElement.parentElement.parentElement.parentElement.dataset.key, element.parentElement.parentElement.dataset.key
	];

	const index = cached.findIndex((item) => item[0] === keys[0] && item[1] === keys[1]);

	if(index > -1) {
		delete cached[index];
		cached = cached.filter(Boolean);

		document.querySelector(`.calculator .categories .category[data-key="${keys[0]}"] .items .item[data-key="${keys[1]}"]`).classList.remove('daily');
		document.querySelector(`.calculator .categories .category[data-key="${keys[0]}"] .items .item[data-key="${keys[1]}"] .daily > span`).innerText = 'is daily';
	}
	else {
		document.querySelectorAll('.calculator .categories .category .items .item.daily').forEach((el) => el.classList.remove('daily'));

		if(cached.length >= 3) {
			const first = cached.shift();

			document.querySelector(`.calculator .categories .category[data-key="${first[0]}"] .items .item[data-key="${first[1]}"]`).classList.remove('daily');
			document.querySelector(`.calculator .categories .category[data-key="${first[0]}"] .items .item[data-key="${first[1]}"] .daily > span`).innerText = 'is daily';
		}

		cached.push(keys);

		cached.forEach((item) => {
			document.querySelector(`.calculator .categories .category[data-key="${item[0]}"] .items .item[data-key="${item[1]}"]`).classList.add('daily');
			document.querySelector(`.calculator .categories .category[data-key="${item[0]}"] .items .item[data-key="${item[1]}"] .daily > span`).innerText = 'is not daily';
		});
	}

	localStorage.setItem('daily', JSON.stringify(cached));

	calculate();
};

document.addEventListener('DOMContentLoaded', boot);